name: build-and-lint

# on which branch you want to set
on:
  push: 
    branches: [main,dev]
  pull_request:
    branches: [main,dev]


jobs:
  build-and-lint:
    runs-on: ubuntu-latest

    steps: 
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20
      
      - name: Install Backend Dependencies
        working-directory: todo_backend
        run: npm ci

      - name: Lint Backend
        working-directory: todo_backend
        run: npm run lint -- --max-warnings=0

      - name: Install Frontend Dependencies
        working-directory: todo_frontend
        run: npm ci
      
      - name: Lint Frontend
        working-directory: todo_frontend
        run: npm run lint -- --max-warnings=0

      - name: Build Backend Image
        run: docker build -t backend ./todo_backend
      
      - name: Build Frontend Image
        run: docker build -t frontend ./todo_frontend
  
  deploy:
    needs : build-and-lint
    if: github.event_name == 'push'
    runs-on: ubuntu-
    steps:
      - name : Checkout (optional)
        uses : actions/checkout@v4

      - name : Add Ec2 Host to known_hosts
        run : |
          mkdir -p ~/.ssh
          ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts
        env :
          EC2_HOST : ${{ secrets.EC2_HOST }}

      - name : Write SSH key
        run : |
          echo "${EC2_KEY}" > ec2_key.pem
          chmod 600 ec2_key.pem
        env :
          EC2_KEY : ${{ secrets.EC2_KEY }}

      - name : Deploy on EC2 ( gti pull + docker compose up -d --build )
        env : 
          EC2_HOST : ${{ secrets.EC2_HOST }}
          EC2_USER : ${{ secrets.EC2_USER }}
          EC2_APP_DIR : ${{ secrets.EC2_APP_DIR }}
        run : |
          ssh -i ec2_key.pem ${EC2_USER}@${EC2_HOST} << EOF
            ssh -e 
            cd "${EC2_APP_DIR}"

            git fetch --all
            git reset --hard origin/main

            docker compose up -d --build

            docker image prune -f 

            docker compose ps 
          EOF

